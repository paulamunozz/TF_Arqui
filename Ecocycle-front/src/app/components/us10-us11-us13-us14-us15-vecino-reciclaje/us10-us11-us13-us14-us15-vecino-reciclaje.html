<div class="reciclaje-container">
  <!-- Título principal -->
  <h1 class="page-title">Mi Reciclaje</h1>

  <!-- Panel de acciones: Puntaje, Filtros y Crear -->
  <div class="panelAcciones">
    <!-- Tarjeta de puntaje -->
    <mat-card class="puntaje-card">
      <mat-card-content>
        <mat-icon class="puntaje-icon">emoji_events</mat-icon>
        <div class="puntaje-info">
          <span class="puntaje-label">Puntaje acumulado</span>
          <span class="puntaje-value">{{ vecino.puntajetotal || 0 }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Filtros con formulario reactivo -->
    <form [formGroup]="formFiltro" class="panelFiltros">
      <!-- Filtro Tipo -->
      <mat-form-field appearance="outline" class="columnaFiltro">
        <mat-label>Tipo</mat-label>
        <mat-select formControlName="tipo" (selectionChange)="aplicarFiltros()">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option value="Vidrio">Vidrio</mat-option>
          <mat-option value="Plástico">Plástico</mat-option>
          <mat-option value="Papel">Papel</mat-option>
          <mat-option value="Electrónicos">Electrónicos</mat-option>
          <mat-option value="Orgánicos">Orgánicos</mat-option>
          <mat-option value="Metal/Lata">Metal/Lata</mat-option>
        </mat-select>
        <mat-icon matPrefix>category</mat-icon>
      </mat-form-field>

      <!-- Filtro Método -->
      <mat-form-field appearance="outline" class="columnaFiltro">
        <mat-label>Método</mat-label>
        <mat-select formControlName="metodo" (selectionChange)="aplicarFiltros()">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option value="En centros físicos de la municipalidad">
            En centros físicos
          </mat-option>
          <mat-option value="Camión de reciclaje de la municipalidad">
            Camión de reciclaje
          </mat-option>
          <mat-option value="En casa">En casa</mat-option>
        </mat-select>
        <mat-icon matPrefix>recycling</mat-icon>
      </mat-form-field>

      <!-- Filtro Fecha Inicio -->
      <mat-form-field appearance="outline" class="columnaFiltro">
        <mat-label>Fecha inicio</mat-label>
        <input
          matInput
          [matDatepicker]="pickerMin"
          formControlName="fechaInicio"
          (dateChange)="aplicarFiltros()"
          placeholder="Seleccione">
        <mat-datepicker-toggle matIconSuffix [for]="pickerMin"></mat-datepicker-toggle>
        <mat-datepicker #pickerMin></mat-datepicker>
      </mat-form-field>

      <!-- Filtro Fecha Fin -->
      <mat-form-field appearance="outline" class="columnaFiltro">
        <mat-label>Fecha fin</mat-label>
        <input
          matInput
          [matDatepicker]="pickerMax"
          formControlName="fechaFin"
          (dateChange)="aplicarFiltros()"
          placeholder="Seleccione">
        <mat-datepicker-toggle matIconSuffix [for]="pickerMax"></mat-datepicker-toggle>
        <mat-datepicker #pickerMax></mat-datepicker>
      </mat-form-field>

      <!-- Botón limpiar filtro -->
      <button
        mat-stroked-button
        type="button"
        class="btnLimpiar"
        (click)="limpiarFiltros()">
        <mat-icon>clear</mat-icon>
        Limpiar
      </button>
    </form>

    <!-- Botón Crear -->
    <button mat-fab extended color="accent" class="btnCrearFab" (click)="abrirModalCrear()">
      <mat-icon>add</mat-icon>
      Crear
    </button>
  </div>

  <!-- Indicador de carga -->
  <div *ngIf="cargando" class="loading-container">
    <mat-spinner diameter="60"></mat-spinner>
    <p class="loading-text">Cargando reciclajes...</p>
  </div>

  <!-- Lista de reciclajes -->
  <div class="reciclajes-list">
    @if (reciclajes.data.length > 0) {
      <!-- Cards de reciclajes paginados -->
      @for (reciclaje of reciclajes.data; track reciclaje.idReciclaje) {
        <mat-card class="reciclaje-card">
          <mat-card-content>
            <div class="card-content">
              <div class="card-info-section">
                <div class="info-item">
                  <mat-icon class="info-icon">scale</mat-icon>
                  <div class="info-text">
                    <span class="info-label">Peso</span>
                    <span class="info-value">{{ reciclaje.peso }} kg</span>
                  </div>
                </div>

                <div class="info-item">
                  <mat-icon class="info-icon">category</mat-icon>
                  <div class="info-text">
                    <span class="info-label">Tipo</span>
                    <span class="info-value">{{ reciclaje.tipo }}</span>
                  </div>
                </div>

                <div class="info-item">
                  <mat-icon class="info-icon">event</mat-icon>
                  <div class="info-text">
                    <span class="info-label">Fecha</span>
                    <span class="info-value">{{ reciclaje.fecha | date:'dd/MM/yyyy' }}</span>
                  </div>
                </div>

                <div class="info-item">
                  <mat-icon class="info-icon">recycling</mat-icon>
                  <div class="info-text">
                    <span class="info-label">Método</span>
                    <span class="info-value">{{ reciclaje.metodo }}</span>
                  </div>
                </div>
              </div>

              <div class="card-actions">
                <button
                  color="primary"
                  (click)="editarReciclaje(reciclaje)"
                  class="btn-action">
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  color="warn"
                  (click)="eliminarReciclaje(reciclaje.idReciclaje)"
                  class="btn-action">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      }

      <!-- Paginador -->
      <div class="paginator-container">
        <mat-paginator
          [length]="reciclajes.data.length"
          [pageSize]="5"
          [pageSizeOptions]="[5, 10, 25, 50]"
          showFirstLastButtons
          aria-label="Seleccione página de reciclajes">
        </mat-paginator>
      </div>
    } @else {
      <!-- Estado vacío -->
      <div class="empty-state">
        <mat-icon class="empty-icon">inbox</mat-icon>
        <h2 class="empty-title">No hay reciclajes registrados</h2>
        <p class="empty-text">¡Empieza a registrar tus reciclajes y acumula puntos!</p>
        <button mat-raised-button color="accent" (click)="abrirModalCrear()">
          <mat-icon>add</mat-icon>
          Crear primer reciclaje
        </button>
      </div>
    }
  </div>

  <!-- Footer contador -->
  <footer class="footer">
    <mat-chip-set>
      <mat-chip highlighted>
        <mat-icon matChipAvatar>inventory_2</mat-icon>
        Reciclajes: {{ reciclajes.data.length }}
      </mat-chip>
    </mat-chip-set>
  </footer>

  <!-- Modal para crear/editar -->
  <div *ngIf="mostrarModal" class="modal-overlay" (click)="cerrarModal()">
    <mat-card class="modal-card" (click)="$event.stopPropagation()">
      <mat-card-header class="modal-header">
        <mat-card-title>
          <mat-icon>{{ modoEdicion ? 'edit' : 'add_circle' }}</mat-icon>
          {{ modoEdicion ? 'Editar Reciclaje' : 'Nuevo Reciclaje' }}
        </mat-card-title>
      </mat-card-header>

      <mat-card-content class="modal-body">
        <form (ngSubmit)="guardarReciclaje()" #modalForm="ngForm">
          <!-- Peso -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Peso (kg)</mat-label>
            <input
              matInput
              type="number"
              [(ngModel)]="reciclajeForm.peso"
              name="peso"
              step="0.01"
              min="0.01"
              required>
            <mat-icon matPrefix>scale</mat-icon>
            <mat-hint>Ingrese el peso en kilogramos</mat-hint>
          </mat-form-field>

          <!-- Tipo -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Tipo de material</mat-label>
            <mat-select [(ngModel)]="reciclajeForm.tipo" name="tipo" required>
              <mat-option value="Vidrio">
                <mat-icon>wine_bar</mat-icon> Vidrio
              </mat-option>
              <mat-option value="Plástico">
                <mat-icon>local_drink</mat-icon> Plástico
              </mat-option>
              <mat-option value="Papel">
                <mat-icon>description</mat-icon> Papel
              </mat-option>
              <mat-option value="Electrónicos">
                <mat-icon>devices</mat-icon> Electrónicos
              </mat-option>
              <mat-option value="Orgánicos">
                <mat-icon>eco</mat-icon> Orgánicos
              </mat-option>
              <mat-option value="Metal/Lata">
                <mat-icon>build</mat-icon> Metal/Lata
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
          </mat-form-field>

          <!-- Método -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Método de reciclaje</mat-label>
            <mat-select [(ngModel)]="reciclajeForm.metodo" name="metodo" required>
              <mat-option value="En centros físicos de la municipalidad">
                <mat-icon>location_city</mat-icon> En centros físicos
              </mat-option>
              <mat-option value="Camión de reciclaje de la municipalidad">
                <mat-icon>local_shipping</mat-icon> Camión de reciclaje
              </mat-option>
              <mat-option value="En casa">
                <mat-icon>home</mat-icon> En casa
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>recycling</mat-icon>
          </mat-form-field>

          <!-- Botones -->
          <mat-card-actions class="modal-actions">
            <button
              mat-stroked-button
              type="button"
              (click)="cerrarModal()"
              [disabled]="guardando">
              <mat-icon>close</mat-icon>
              Cancelar
            </button>
            <button
              mat-raised-button
              color="accent"
              type="submit"
              [disabled]="!modalForm.valid || guardando">
              <mat-spinner *ngIf="guardando" diameter="20" class="spinner-button"></mat-spinner>
              <mat-icon *ngIf="!guardando">{{ modoEdicion ? 'save' : 'add' }}</mat-icon>
              {{ guardando ? 'Guardando...' : (modoEdicion ? 'Guardar' : 'Registrar') }}
            </button>
          </mat-card-actions>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>
